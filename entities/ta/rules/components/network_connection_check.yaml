rules:
  validators:
    seaf.validation.ta.components.network_connection_check:
      uid: SEAF-TA-NETWORK-COMP-CONN-001
      title: Проверка корректности связи Сетевого устройства с сетями
      description: |
        Проверяет, что у каждого Сетевого устройства (seaf.ta.components.network)
        указано поле `network_connection`, оно не пустое и каждый его элемент
        ссылается на реально существующую сеть.
      correction: |
        Убедитесь, что для каждого объекта типа `seaf.ta.components.network` указано
        непустое поле `network_connection` и что каждая указанная сеть
        определена в `seaf.ta.services.network`.
      source: |
        ([
          $each($."seaf.ta.components.network", function($component, $component_key) {
            (
                $connections := $component.network_connection;
                $not($exists($connections)) or $count($connections) = 0 ? {
                    "uid": "seaf.validation.ta.network_connection_check.missing." & $component_key,
                    "title": "У Сетевого устройства '" & $component.title & "' отсутствует или не заполнено поле network_connection.",
                    "correction": "Необходимо указать хотя бы одну сеть для поля `network_connection`.",
                    "description": "У Сетевого устройства '" & $component.title & "' (UID: " & $component_key & ") отсутствует или не заполнено поле `network_connection`."
                } : (
                    $defined_network_keys := $keys($."seaf.ta.services.network");
                    $invalid_connections := $filter($connections, function($c) { $not($c in $defined_network_keys) });
                    $count($invalid_connections) > 0 ? {
                        "uid": "seaf.validation.ta.network_connection_check.notfound." & $component_key,
                        "title": "Сетевое устройство '" & $component.title & "' содержит ссылку на несуществующую сеть.",
                        "correction": "Проверьте все сети в поле `network_connection` для устройства '" & $component.title & "'. Одна или несколько из них не определены в `seaf.ta.services.network`.",
                        "description": "Сетевое устройство '" & $component.title & "' (UID: " & $component_key & ") ссылается на несуществующие сети: " & $join($invalid_connections, ", ")
                    }
                )
            )
          })
        ])