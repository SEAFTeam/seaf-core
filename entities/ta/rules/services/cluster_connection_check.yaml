rules:
  validators:
    seaf.validation.ta.services.cluster_connection_check:
      uid: SEAF-TA-CLUSTER-CONN-001
      title: Проверка корректности связи Кластера с сетями
      description: |
        Проверяет, что у каждого Кластера (seaf.ta.services.cluster)
        указано поле `network_connection`, оно не пустое и каждый его элемент
        ссылается на реально существующую сеть.
      correction: |
        Убедитесь, что для каждого объекта типа `seaf.ta.services.cluster` указано
        непустое поле `network_connection` и что каждая указанная сеть
        определена в `seaf.ta.services.network`.
      source: |
        ([
          $each($."seaf.ta.services.cluster", function($cluster, $cluster_key) {
            (
                $connections := $cluster.network_connection;
                $not($exists($connections)) or $count($connections) = 0 ? {
                    "uid": "seaf.validation.ta.cluster_connection_check.missing." & $cluster_key,
                    "title": "У Кластера '" & $cluster.title & "' отсутствует или не заполнено поле network_connection.",
                    "correction": "Необходимо указать хотя бы одну сеть для поля `network_connection`.",
                    "description": "У Кластера '" & $cluster.title & "' (UID: " & $cluster_key & ") отсутствует или не заполнено поле `network_connection`."
                } : (
                    $defined_network_keys := $keys($."seaf.ta.services.network");
                    $invalid_connections := $filter($connections, function($c) { $not($c in $defined_network_keys) });
                    $count($invalid_connections) > 0 ? {
                        "uid": "seaf.validation.ta.cluster_connection_check.notfound." & $cluster_key,
                        "title": "Кластер '" & $cluster.title & "' содержит ссылку на несуществующую сеть.",
                        "correction": "Проверьте все сети в поле `network_connection` для кластера '" & $cluster.title & "'. Одна или несколько из них не определены в `seaf.ta.services.network`.",
                        "description": "Кластер '" & $cluster.title & "' (UID: " & $cluster_key & ") ссылается на несуществующие сети: " & $join($invalid_connections, ", ")
                    }
                )
            )
          })
        ])