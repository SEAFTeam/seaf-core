rules:
  validators:
    seaf.validation.ta.kb_connection_check:
      uid: SEAF-TA-KB-CONN-001
      title: Проверка корректности связи Сервиса КБ с сетями
      description: |
        Проверяет, что у каждого Сервиса КБ (seaf.ta.services.kb)
        указано поле `network_connection`, оно не пустое и каждый его элемент
        ссылается на реально существующую сеть.
      correction: |
        Убедитесь, что для каждого объекта типа `seaf.ta.services.kb` указано
        непустое поле `network_connection` и что каждая указанная сеть
        определена в `seaf.ta.services.network`.
      source: |
        ([
          $each($."seaf.ta.services.kb", function($kb_service, $kb_key) {
            (
                $connections := $kb_service.network_connection;
                $not($exists($connections)) or $count($connections) = 0 ? {
                    "uid": "seaf.validation.ta.kb_connection_check.missing." & $kb_key,
                    "title": "У Сервиса КБ '" & $kb_service.title & "' отсутствует или не заполнено поле network_connection.",
                    "correction": "Необходимо указать хотя бы одну сеть для поля `network_connection`.",
                    "description": "У Сервиса КБ '" & $kb_service.title & "' (UID: " & $kb_key & ") отсутствует или не заполнено поле `network_connection`."
                } : (
                    $defined_network_keys := $keys($."seaf.ta.services.network");
                    $invalid_connections := $filter($connections, function($c) { $not($c in $defined_network_keys) });
                    $count($invalid_connections) > 0 ? {
                        "uid": "seaf.validation.ta.kb_connection_check.notfound." & $kb_key,
                        "title": "Сервис КБ '" & $kb_service.title & "' содержит ссылку на несуществующую сеть.",
                        "correction": "Проверьте все сети в поле `network_connection` для сервиса '" & $kb_service.title & "'. Одна или несколько из них не определены в `seaf.ta.services.network`.",
                        "description": "Сервис КБ '" & $kb_service.title & "' (UID: " & $kb_key & ") ссылается на несуществующие сети: " & $join($invalid_connections, ", ")
                    }
                )
            )
          })
        ])